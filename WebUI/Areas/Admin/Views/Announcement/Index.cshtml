@using WebUI.Areas.Admin.Models.ViewModels.Announcement_
@model AnnouncementViewModel
@{
	ViewData["Title"] = "Duyurular";
}

<div class="card">
	<div class="card-header">
		<form id="form_page_filter">
			<div class="row row-gap-4">
				<div class="col-md-4 col-md-6 col-12">
					<div class="input-group">
						<span class="input-group-text bg-lightest">
							Silinenleri Göster
						</span>
						<div class="input-group-text">
							<input name="IsDeleted" type="checkbox" class="form-check-input" />
						</div>
					</div>
				</div>
				<div class="col-md-3 col-sm-4 col-6">
					<button onclick="InitilazeTable(this)" type="button" class="btn btn-light">
						<span class="dynamic-content">
							<i class="fa-solid fa-search me-2"></i>
							Ara
						</span>
					</button>
				</div>
			</div>
		</form>
	</div>
	<div class="card-body">
		<table id="table_page" class="table table-hover table-striped">
			<thead class="bg-light">
				<tr>
					<th>Title</th>
					<th>Mesaj</th>
					<th>Oluşturma Tarihi</th>
					<th>Son Düzenlenme Tarihi</th>
					<th>Durum</th>
					<th>Silinme Tarihi</th>
					<th>İşlemler</th>
				</tr>
			</thead>
		</table>
	</div>
</div>

@section Scripts {
	<script>

		let PageTable;

		$(document).ready(function(){
			InitilazeTable();
		})

		function InitilazeTable(e) {

			PageTable = DatatableManager.Create({serverSide: true,
				tableId: 'table_page',
				path: 'Announcement/DatatableServerSide',
				method: 'Post',
				buttonElement: e,
				requestData: {
					filter: {
						operator: 'base',
						logic: 'and',
						filters: [
							{
								operator: 'eq',
								field: "IsDeleted",
								value: false,
								logic: 'or',
								filters: [
									{
										operator: 'eq',
										field: "IsDeleted",
										value: $("input[name='IsDeleted']").val(),
									}
								]
							}

						]
					}
				},
				columns: [
					{data: 'title' },
					{data: 'message' },
					{
						data: 'createDateUtc',
						render: function (data) {
							if(data == null) return '';
							return moment(data).format('DD.MM.YYYY HH:mm');
						}
					},
					{
						data: 'updateDateUtc',
						render: function (data) {
							if(data == null) return '';
							return moment(data).format('DD.MM.YYYY HH:mm');
						}
					},
					{
						data: 'isDeleted',
						render: function (data) {
							if(data == true) return (`<span class="badge rounded-pill bg-label-danger"><i class="fa-solid fa-xmark"></i></span>`);
							else if(data == false) return (`<span class="badge rounded-pill bg-label-success"><i class="fa-solid fa-check"></i></span>`);
							else return ('');
						}
					},
					{
						data: 'deletedDateUtc',
						render: function (data) {
							if(data == null) return '';
							return moment(data).format('DD.MM.YYYY HH:mm');
						}
					},
					{
						data: null,
						defaultContent: '',
						searchable: false,
						createdCell: function (td, cellData, rowData, row, col)
						{
							let deleteHandleButton = rowData.isDeleted == true ?
								UIManager.UndoDeleteButtonTable({
									requestUrl: 'Announcement/UndoDelete',
									requestData: {
										"id": rowData.id
									},
									pageTable:PageTable
								}) :
								UIManager.DeleteButtonTable({
									requestUrl: 'Announcement/Delete',
									requestData: {
										"id": rowData.id
									},
									pageTable:PageTable
								});

							DatatableManager.AppendRowButtons(td,
								[
									// 1) Update Button
									UIManager.UpdateButtonTable({
										title: "Bilgileri Düzenle",
										formGetterUrl: 'Announcement/UpdateForm',
										requestData: {
											"id": rowData.id
										},
										pageTable: PageTable
									}),
									// 2) Delete Button
									deleteHandleButton
								]
							);
						}
					}
				],
				customButtons:
				[
					{
						text: '<span class="dynamic-content"><i class="fa-solid fa-file-circle-plus me-2"></i>Yeni Duyuru Ekle</span>',
						className: 'create-new btn btn-primary mx-2',
						action: (e_btn) =>
						{
							UIManager.InsertModal({
								title: "Yeni Duyuru Ekle",
								formGetterUrl: 'Announcement/CreateForm',
								e_btn:e_btn.currentTarget,
								pageTable: PageTable
							})
						}
					}
				]
			})
		}
	</script>
}